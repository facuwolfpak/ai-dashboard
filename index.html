<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tariff & HS Code Finder</title>
  <style>
    :root{--bg:#ffffff;--card:#ffffff;--muted:#5b6b7a;--accent:#0b6cff;--ok:#1a7f37;--err:#d62828}
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,Apple Color Emoji,Segoe UI Emoji;background:#fff;color:#0f172a}
    header{padding:24px 20px 8px;max-width:1100px;margin:0 auto}
    h1{margin:0 0 6px;font-weight:800;letter-spacing:.2px}
    p.sub{margin:0;color:var(--muted)}
    main{max-width:1100px;margin:24px auto 80px;padding:0 20px;display:grid;grid-template-columns:1.15fr .85fr;gap:20px}
    .card{background:var(--card);border:1px solid rgba(15,23,42,.08);border-radius:14px;box-shadow:0 6px 24px rgba(2,6,23,.06)}
    .card h2{margin:0 0 8px;font-size:18px}
    .pad{padding:18px}
    label{display:block;font-size:13px;color:var(--muted);margin:14px 0 6px}
    input[type=text], textarea, select{width:100%;background:#fff;border:1px solid rgba(15,23,42,.15);color:#0f172a;border-radius:10px;padding:10px 12px}
    textarea{color:#0b6cff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    button{appearance:none;background:var(--accent);color:#001221;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    button:disabled{opacity:.5}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .results{padding:0 0 10px}
    .result{border-top:1px solid rgba(255,255,255,.08);padding:12px 0}
    code, pre{background:#f8fafc;border:1px solid rgba(15,23,42,.08);border-radius:8px;padding:8px 10px;color:#0b3a73;display:block;overflow:auto}
    .tag{display:inline-block;background:#eef2ff;color:#1e3a8a;border:1px solid rgba(11,108,255,.25);padding:2px 8px;border-radius:999px;font-size:12px;margin:2px 8px 2px 0}
    a{color:#77d3ff}
    footer{max-width:1100px;margin:24px auto;padding:0 20px}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .callout{background:#09142c;border-left:3px solid var(--accent);padding:10px 12px;border-radius:10px}
  </style>
</head>
<body>
  <header>
    <h1>Tariff &amp; HS Code Finder (beta)</h1>
    <p class="sub">Enter a product description and choose origin/destination. The tool will search official tariff services and return likely HS/HTS codes and duty info where live APIs exist.</p>
  </header>

  <main>
    <section class="card">
      <div class="pad">
        <h2>Search</h2>
        <form id="form">
          <label>Product category</label>
          <input type="text" id="category" placeholder="e.g., almond milk, beef jerky, lithium‑ion battery" required />

          <label>Details (materials, % composition, use, packaging, processing)</label>
          <textarea id="details" placeholder="e.g., plant‑based beverage; 1L aseptic carton; almond base; sweetened"></textarea>

          <div class="row">
            <div>
              <label>Country of origin</label>
              <select id="origin"></select>
            </div>
            <div>
              <label>Country of destination</label>
              <select id="destination"></select>
            </div>
          </div>

          <div class="row" style="margin-top:14px">
            <button id="go" type="submit">Find HS &amp; tariffs</button>
            <button id="clear" type="button">Clear</button>
          </div>
          <p class="hint">Tip: Be specific (composition %, fat %, whether sweetened/unsweetened, fresh vs cooked, etc.). Classification depends on the exact description.</p>
        </form>
      </div>
    </section>

    <section class="card">
      <div class="pad">
        <h2>Live sources & reliability</h2>
        <div class="callout small">
          <p><strong>United States (imports):</strong> USITC HTS REST API (<a href="https://hts.usitc.gov/" target="_blank" rel="noopener">HTS</a>) queried via <code>https://hts.usitc.gov/reststop</code>. Updated with each HTS revision. See API guide for endpoints. </p>
          <p><strong>United Kingdom:</strong> GOV.UK Trade Tariff API (<a href="https://api.trade-tariff.service.gov.uk/" target="_blank" rel="noopener">docs</a>) at <code>https://www.trade-tariff.service.gov.uk/uk/api</code>, updated daily, no API key required.</p>
          <p><strong>European Union & other countries:</strong> For now this tool links you to official portals (EU <em>Access2Markets</em>, WTO/UNCTAD <em>WITS/TRAINs</em>) with prefilled guidance where possible.</p>
        </div>
        <p class="small muted">Duty outcomes can change with quotas, safeguards, anti‑dumping, preferential programs (FTA), and other measures. Always verify with local customs or a broker before filing.</p>
      </div>
    </section>

    <section id="output" class="card" style="grid-column: 1 / span 2">
      <div class="pad">
        <h2>Results</h2>
        <div id="status" class="muted small">Waiting for your search…</div>
        <div id="results" class="results"></div>
      </div>
    </section>
  </main>

  <footer class="small muted">
    <p>Sources: USITC HTS API; GOV.UK Trade Tariff API; EU Access2Markets (TARIC); World Bank WITS/UNCTAD TRAINS. This page performs only client‑side requests to official APIs and displays direct links to authoritative tariff pages.</p>
  </footer>

  <script>
    // --- Country list (ISO alpha-2 where available) ---
    const countries = [
      {code:"US", name:"United States"},
      {code:"GB", name:"United Kingdom"},
      {code:"EU", name:"European Union"},
      {code:"AU", name:"Australia"}, {code:"CA", name:"Canada"}, {code:"CN", name:"China"}, {code:"JP", name:"Japan"}, {code:"KR", name:"Korea, Republic of"}, {code:"MX", name:"Mexico"}, {code:"SG", name:"Singapore"}, {code:"BR", name:"Brazil"}, {code:"CL", name:"Chile"}, {code:"CO", name:"Colombia"}, {code:"IL", name:"Israel"}, {code:"AE", name:"United Arab Emirates"}
    ].sort((a,b)=>a.name.localeCompare(b.name));

    const originSel = document.getElementById('origin');
    const destSel = document.getElementById('destination');
    countries.forEach(c=>{
      const o1=document.createElement('option'); o1.value=c.code; o1.textContent=c.name; originSel.appendChild(o1);
      const o2=document.createElement('option'); o2.value=c.code; o2.textContent=c.name; destSel.appendChild(o2);
    });
    originSel.value = 'US';
    destSel.value = 'US';

    const form = document.getElementById('form');
    const resultsEl = document.getElementById('results');
    const statusEl = document.getElementById('status');
    const clearBtn = document.getElementById('clear');

    clearBtn.onclick = () => { resultsEl.innerHTML = ''; statusEl.textContent = 'Cleared.'; };

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const category = document.getElementById('category').value.trim();
      const details = document.getElementById('details').value.trim();
      const origin = originSel.value; const dest = destSel.value;
      const query = [category, details].filter(Boolean).join(' ').trim();
      resultsEl.innerHTML = '';
      statusEl.textContent = 'Searching…';

      try {
        if(!query) throw new Error('Please enter a product description.');

        // Always try to propose HS candidates using the UK commodity index (works globally)
        await searchUKTariff(query, origin, {measures: dest === 'GB'});

        // Destination-specific sections
        if(dest === 'US') {
          await searchUSITC(query);
        } else if (dest === 'GB') {
          // measures already included above
        } else if (dest === 'EU') {
          addResult(`EU (TARIC)`, `Use the EU Access2Markets portal to combine your product and origin/destination. This link opens the portal.`, [
            linkTag('Open Access2Markets', 'https://trade.ec.europa.eu/access-to-markets/en/content/welcome-access2markets-market-access-database-users')
          ]);
          addResult('Global (WITS/UNCTAD TRAINS, averages)', 'Use WITS for MFN & preferential tariff statistics and HS6-level data (registration may be required).', [
            linkTag('WITS API guide', 'https://wits.worldbank.org/witsapiintro.aspx?lang=en')
          ]);
        } else {
          // For other destinations (e.g., SG, AU, MX, etc.), we show HS candidates above, then link to portals.
          addResult('Destination-specific tariffs', `No public API for ${destSel.options[destSel.selectedIndex].text} from the browser. Use the official portal below with one of the HS candidates shown above.`, [
            linkTag('WITS country portal', 'https://wits.worldbank.org/'),
            linkTag('Access2Markets (if trading with EU)', 'https://trade.ec.europa.eu/access-to-markets/en/content/welcome-access2markets-market-access-database-users')
          ]);
        }
        statusEl.textContent = 'Done.';
      } catch(err){
        statusEl.textContent = 'Error: ' + err.message;
        console.error(err);
      }
    });

    function addResult(title, subtitle, tags=[], extraHTML=''){
      const d=document.createElement('div'); d.className='result';
      d.innerHTML = `<div><span class="tag">${title}</span></div><div class="muted small" style="margin:4px 0 8px">${subtitle||''}</div>${extraHTML}`;
      if(tags && tags.length){ const wrap=document.createElement('div'); tags.forEach(t=>wrap.appendChild(t)); d.appendChild(wrap); }
      resultsEl.appendChild(d);
    }
    function linkTag(text, href){ const a=document.createElement('a'); a.href=href; a.target='_blank'; a.rel='noopener'; a.textContent=text; a.className='tag'; return a; }

    // --- US: HTS search (USITC) ---
    async function searchUSITC(query){
      const url = `https://hts.usitc.gov/reststop/search?keyword=${encodeURIComponent(query)}`;
      let data;
      try{
        const r = await fetch(url, {mode:'cors'});
        if(!r.ok) throw new Error('HTTP '+r.status);
        data = await r.json();
      } catch(err){
        // CORS or network error — USITC often blocks browser origins. Provide graceful fallback.
        addResult('United States (HTS)', 'Live API access from static sites is often blocked by CORS on hts.usitc.gov. Use the direct HTS search link below, then copy the HTS code back here if you want to compare elsewhere.', [
          linkTag('Open HTS with your query', `https://hts.usitc.gov/search?query=${encodeURIComponent(query)}`)
        ]);
        return;
      }
      const items = Array.isArray(data) ? data.slice(0, 10) : [];
      if(items.length===0){ addResult('United States (HTS)', 'No matches returned. Try simplifying the description or different keywords.'); return; }

      addResult('United States (HTS)', 'Top likely HTS matches. Click the HTS page to see duty (General/Special) and notes.');
      items.forEach(it=>{
        const hts = it.htsno || it.number || it.hts_no || '';
        const descr = (it.shortdes || it.descr || it.description || '').trim();
        const duty = (it.general || it.rate || '');
        const link = `https://hts.usitc.gov/search?query=${encodeURIComponent(hts || descr)}`;
        const html = `
          <div style="margin:8px 0">
            <div><strong>${hts || '(HTS candidate)'}</strong> — ${escapeHtml(descr)}</div>
            <div class="small muted">General rate (if available): ${escapeHtml(String(duty || 'see page'))}</div>
            <div class="small">${linkAnchor('Open in HTS', link)} · ${rawJsonToggle(it)}</div>
          </div>`;
        addResult('', '', [], html);
      });
    }

    // --- UK: Trade Tariff API (search references, then commodity detail incl. measures) ---
    async function searchUKTariff(query, origin, opts={measures:false}){
      // Step 1: find references (keywords -> candidate commodities)
      const url = 'https://api.trade-tariff.service.gov.uk/uk/api/search_references?query=' + encodeURIComponent(query);
      let ref;
      try{
        const r = await fetch(url, { headers: { 'Accept': 'application/vnd.hmrc.2.0+json' } });
        if(!r.ok) throw new Error('UK Trade Tariff search failed');
        ref = await r.json();
      }catch(e){
        addResult('HS candidates (fallback)', 'Could not query UK tariff API. Try again later, or refine your search.');
        return;
      }
      const refs = (ref && ref.data) ? ref.data.slice(0,8) : [];
      if(refs.length===0){ addResult('HS candidates', 'No matches returned. Try different words.'); return; }

      addResult(opts.measures ? 'United Kingdom' : 'HS candidates (from UK index)', opts.measures ? 'Top likely UK commodity matches with live measures (duty) when available.' : 'Likely HS/commodity matches. Open the commodity pages for full details, then use the HS elsewhere.');

      for(const sr of refs){
        const commodityId = (sr.attributes && sr.attributes.reference_class === 'Commodity') ? sr.attributes.reference : null;
        const label = (sr.attributes && sr.attributes.title) ? sr.attributes.title : 'Match';
        const ui = 'https://www.trade-tariff.service.gov.uk/commodities/' + encodeURIComponent(sr.attributes.reference || '');
        if(!commodityId){
          const html = `<div style="margin:8px 0"><strong>${escapeHtml(label)}</strong> — ${linkAnchor('Open commodity', ui)} ${rawJsonToggle(sr)}</div>`;
          addResult('', '', [], html);
          continue;
        }
        if(!opts.measures){
          const html = `<div style="margin:8px 0"><strong>${commodityId}</strong> — ${escapeHtml(label)} · ${linkAnchor('Open commodity', ui)}</div>`;
          addResult('', '', [], html);
          continue;
        }
        // With measures (UK destination)
        const cUrl = `https://api.trade-tariff.service.gov.uk/uk/api/commodities/${commodityId}`;
        const cr = await fetch(cUrl, { headers: { 'Accept': 'application/vnd.hmrc.2.0+json' } });
        const cd = await cr.json();
        const desc = cd?.data?.attributes?.description || label;
        const measures = (cd?.included || []).filter(x=>x.type==='measure');
        const lines = measures.map(m=>{
          const rate = m?.attributes?.duty_expression?.formatted || '';
          const geo  = m?.attributes?.geographical_area_description || m?.attributes?.geographical_area_id || '';
          const type = m?.attributes?.measure_type_description || '';
          return rate ? `• ${escapeHtml(type)} — <strong>${escapeHtml(rate)}</strong> (${escapeHtml(geo)})` : null;
        }).filter(Boolean).slice(0,6).join('<br>');

        const commodityUI = `https://www.trade-tariff.service.gov.uk/commodities/${commodityId}`;
        const html = `
          <div style="margin:8px 0">
            <div><strong>${commodityId}</strong> — ${escapeHtml(desc)}</div>
            <div class="small" style="margin:6px 0">${lines || 'Open commodity to view measures (duty, VAT, preferences).'}</div>
            <div class="small">${linkAnchor('Open in UK Tariff', commodityUI)} · ${rawJsonToggle(cd)}</div>
          </div>`;
        addResult('', '', [], html);
      }
    } });
      if(!r.ok) throw new Error('UK Trade Tariff search failed');
      const ref = await r.json();
      const refs = (ref && ref.data) ? ref.data.slice(0,8) : [];
      if(refs.length===0){ addResult('United Kingdom', 'No matches returned. Try different words.'); return; }

      addResult('United Kingdom', 'Top likely UK commodity matches with live measures (duty) when available.');

      for(const sr of refs){
        const commodityId = (sr.attributes && sr.attributes.reference_class === 'Commodity') ? sr.attributes.reference : null;
        const label = (sr.attributes && sr.attributes.title) ? sr.attributes.title : 'Match';
        if(!commodityId){
          // Show the reference and link to public UI
          const ui = 'https://www.trade-tariff.service.gov.uk/commodities/' + encodeURIComponent(sr.attributes.reference || '');
          const html = `<div style="margin:8px 0"><strong>${escapeHtml(label)}</strong> — ${linkAnchor('Open commodity', ui)} ${rawJsonToggle(sr)}</div>`;
          addResult('', '', [], html);
          continue;
        }
        // Step 2: fetch commodity detail (includes measures & duty rates)
        const cUrl = `https://api.trade-tariff.service.gov.uk/uk/api/commodities/${commodityId}`;
        const cr = await fetch(cUrl, { headers: { 'Accept': 'application/vnd.hmrc.2.0+json' } });
        const cd = await cr.json();
        const desc = cd?.data?.attributes?.description || label;
        const measures = (cd?.included || []).filter(x=>x.type==='measure');
        // Try to surface ad valorem third-country (erga omnes) measures
        const lines = measures.map(m=>{
          const rate = m?.attributes?.duty_expression?.formatted || '';
          const geo  = m?.attributes?.geographical_area_description || m?.attributes?.geographical_area_id || '';
          const type = m?.attributes?.measure_type_description || '';
          return rate ? `• ${escapeHtml(type)} — <strong>${escapeHtml(rate)}</strong> (${escapeHtml(geo)})` : null;
        }).filter(Boolean).slice(0,6).join('<br>');

        const commodityUI = `https://www.trade-tariff.service.gov.uk/commodities/${commodityId}`;
        const html = `
          <div style="margin:8px 0">
            <div><strong>${commodityId}</strong> — ${escapeHtml(desc)}</div>
            <div class="small" style="margin:6px 0">${lines || 'Open commodity to view measures (duty, VAT, preferences).'}</div>
            <div class="small">${linkAnchor('Open in UK Tariff', commodityUI)} · ${rawJsonToggle(cd)}</div>
          </div>`;
        addResult('', '', [], html);
      }
    }

    // --- helpers ---
    function linkAnchor(text, href){ return `<a href="${href}" target="_blank" rel="noopener">${text}</a>` }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])) }
    function rawJsonToggle(obj){
      const id = 'j' + Math.random().toString(36).slice(2);
      const pretty = escapeHtml(JSON.stringify(obj, null, 2));
      return `<details style="display:inline-block"><summary>raw JSON</summary><pre>${pretty}</pre></details>`;
    }
  </script>
</body>
</html>
