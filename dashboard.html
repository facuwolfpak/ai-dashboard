<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Drink Category Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen text-white">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold mb-2 bg-gradient-to-r from-cyan-400 to-purple-400 bg-clip-text text-transparent">
                Energy Drink Category Analyzer
            </h1>
            <p class="text-gray-300 text-lg">AI-Powered Market Intelligence Tool</p>
        </div>

        <!-- File Upload Section -->
        <div id="uploadSection" class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-8 shadow-2xl border border-purple-500/20 mb-8">
            <div class="text-center">
                <div class="mb-4">
                    <svg class="mx-auto h-16 w-16 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                </div>
                <label for="fileInput" class="cursor-pointer inline-block">
                    <span class="px-8 py-3 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition-all shadow-lg hover:shadow-purple-500/50 inline-block">
                        Upload Excel File
                    </span>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden">
                </label>
                <p class="mt-4 text-gray-400 text-sm">Upload your Energy Drink Category data file</p>
                <div id="fileStatus" class="mt-4 text-sm"></div>
            </div>
        </div>

        <!-- Query Interface -->
        <div id="querySection" class="hidden bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 shadow-2xl border border-purple-500/20 mb-8">
            <div class="mb-6">
                <label class="block text-sm font-medium mb-3 text-purple-300">Ask a question about the data:</label>
                <div class="flex gap-3">
                    <input type="text" id="queryInput" 
                           placeholder="e.g., What are the top 10 brands by dollar sales?"
                           class="flex-1 px-4 py-3 bg-slate-700/50 border border-purple-500/30 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <button onclick="processQuery()" 
                            class="px-8 py-3 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition-all shadow-lg hover:shadow-purple-500/50">
                        Analyze
                    </button>
                </div>
            </div>

            <!-- Quick Questions -->
            <div class="mb-4">
                <p class="text-sm text-gray-400 mb-2">Quick questions:</p>
                <div class="flex flex-wrap gap-2">
                    <button onclick="setQuery('top brands')" class="px-3 py-1.5 bg-slate-700/70 hover:bg-slate-600 rounded-full text-sm transition-colors">
                        Top Brands
                    </button>
                    <button onclick="setQuery('best performing')" class="px-3 py-1.5 bg-slate-700/70 hover:bg-slate-600 rounded-full text-sm transition-colors">
                        Best Performing
                    </button>
                    <button onclick="setQuery('worst performing')" class="px-3 py-1.5 bg-slate-700/70 hover:bg-slate-600 rounded-full text-sm transition-colors">
                        Worst Performing
                    </button>
                    <button onclick="setQuery('market share')" class="px-3 py-1.5 bg-slate-700/70 hover:bg-slate-600 rounded-full text-sm transition-colors">
                        Market Share
                    </button>
                    <button onclick="setQuery('growth leaders')" class="px-3 py-1.5 bg-slate-700/70 hover:bg-slate-600 rounded-full text-sm transition-colors">
                        Growth Leaders
                    </button>
                    <button onclick="setQuery('price analysis')" class="px-3 py-1.5 bg-slate-700/70 hover:bg-slate-600 rounded-full text-sm transition-colors">
                        Price Analysis
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            <!-- Answer Card -->
            <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 shadow-2xl border border-cyan-500/20 mb-6">
                <h2 class="text-2xl font-bold mb-4 text-cyan-400">Analysis Results</h2>
                <div id="answerText" class="text-gray-200 leading-relaxed"></div>
            </div>

            <!-- Data Table -->
            <div id="tableContainer" class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 shadow-2xl border border-purple-500/20 mb-6 hidden">
                <h3 class="text-xl font-bold mb-4 text-purple-400">Detailed Data</h3>
                <div class="overflow-x-auto">
                    <table id="dataTable" class="w-full text-sm">
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Chart -->
            <div id="chartContainer" class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 shadow-2xl border border-pink-500/20 hidden">
                <h3 class="text-xl font-bold mb-4 text-pink-400">Visual Analysis</h3>
                <canvas id="dataChart" class="max-h-96"></canvas>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="text-center py-8 hidden">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-purple-500"></div>
            <p class="mt-4 text-gray-400">Analyzing data...</p>
        </div>
    </div>

    <script>
        let energyDrinkData = {};
        let currentChart = null;

        // File upload handler
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('fileStatus').innerHTML = '<span class="text-yellow-400">Loading file...</span>';

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, {
                    cellStyles: true,
                    cellFormulas: true,
                    cellDates: true
                });

                const sheetNames = workbook.SheetNames.filter(name => name !== 'Index');
                
                sheetNames.forEach(sheetName => {
                    const sheet = workbook.Sheets[sheetName];
                    const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
                    
                    let headerRowIndex = -1;
                    for (let i = 0; i < Math.min(10, rawData.length); i++) {
                        if (rawData[i] && rawData[i][0] === 'Product') {
                            headerRowIndex = i;
                            break;
                        }
                    }
                    
                    if (headerRowIndex !== -1) {
                        const headers = rawData[headerRowIndex];
                        const dataRows = rawData.slice(headerRowIndex + 1);
                        
                        const parsedData = dataRows.map(row => {
                            const obj = {};
                            headers.forEach((header, idx) => {
                                if (header) {
                                    obj[header.trim()] = row[idx];
                                }
                            });
                            return obj;
                        }).filter(row => row.Product);
                        
                        energyDrinkData[sheetName] = parsedData;
                    }
                });

                document.getElementById('fileStatus').innerHTML = `<span class="text-green-400">âœ“ File loaded successfully! ${Object.keys(energyDrinkData).length} sheets, ${energyDrinkData['1']?.length || 0} products</span>`;
                document.getElementById('uploadSection').classList.add('hidden');
                document.getElementById('querySection').classList.remove('hidden');
                
                // Auto-show top brands
                setTimeout(() => {
                    setQuery('top brands');
                }, 500);
            } catch (error) {
                document.getElementById('fileStatus').innerHTML = `<span class="text-red-400">Error loading file: ${error.message}</span>`;
            }
        });

        function setQuery(query) {
            document.getElementById('queryInput').value = query;
            processQuery();
        }

        function processQuery() {
            const query = document.getElementById('queryInput').value.toLowerCase();
            if (!query) return;

            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');

            setTimeout(() => {
                analyzeQuery(query);
                document.getElementById('loadingIndicator').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');
                window.scrollTo({ top: document.getElementById('resultsSection').offsetTop - 100, behavior: 'smooth' });
            }, 500);
        }

        function analyzeQuery(query) {
            const data = energyDrinkData['1'] || [];
            
            if (query.includes('top') && query.includes('brand')) {
                showTopBrands(data);
            } else if (query.includes('best') || query.includes('growth leader')) {
                showBestPerforming(data);
            } else if (query.includes('worst') || query.includes('declining')) {
                showWorstPerforming(data);
            } else if (query.includes('market share')) {
                showMarketShare(data);
            } else if (query.includes('price')) {
                showPriceAnalysis(data);
            } else {
                showTopBrands(data);
            }
        }

        function showTopBrands(data) {
            const brands = data.filter(row => {
                const product = row.Product || '';
                const spaces = product.match(/^\s*/)[0].length;
                return spaces === 6 && row['Dollar Sales'] > 0;
            });

            brands.sort((a, b) => (b['Dollar Sales'] || 0) - (a['Dollar Sales'] || 0));
            const top10 = brands.slice(0, 10);

            const totalSales = brands.reduce((sum, b) => sum + (b['Dollar Sales'] || 0), 0);
            const top10Sales = top10.reduce((sum, b) => sum + (b['Dollar Sales'] || 0), 0);
            const top10Share = ((top10Sales / totalSales) * 100).toFixed(1);

            document.getElementById('answerText').innerHTML = `
                <p class="text-lg mb-4">The top 10 brands represent <strong class="text-cyan-400">${top10Share}%</strong> of total category sales.</p>
                <p class="mb-2">Here are the leading brands:</p>
                <ol class="list-decimal list-inside space-y-1 ml-4">
                    ${top10.map((b, i) => `
                        <li><strong>${b.Product.trim()}</strong>: $${formatNumber(b['Dollar Sales'])} 
                        (${((b['Dollar Sales % Change vs YA'] || 0) * 100).toFixed(1)}% vs YA)</li>
                    `).join('')}
                </ol>
            `;

            displayTable(top10, ['Product', 'Dollar Sales', 'Dollar Sales % Change vs YA', 'Unit Sales', 'Price per Unit']);

            createChart(
                top10.map(b => b.Product.trim()),
                top10.map(b => b['Dollar Sales']),
                'Top 10 Brands by Dollar Sales',
                'bar'
            );
        }

        function showBestPerforming(data) {
            const brands = data.filter(row => {
                const product = row.Product || '';
                const spaces = product.match(/^\s*/)[0].length;
                return spaces === 6 && row['Dollar Sales'] > 10000 && row['Dollar Sales % Change vs YA'] !== null;
            });

            brands.sort((a, b) => (b['Dollar Sales % Change vs YA'] || -999) - (a['Dollar Sales % Change vs YA'] || -999));
            const top10 = brands.slice(0, 10);

            document.getElementById('answerText').innerHTML = `
                <p class="text-lg mb-4">The fastest-growing brands in the energy drink category:</p>
                <ol class="list-decimal list-inside space-y-1 ml-4">
                    ${top10.map(b => `
                        <li><strong>${b.Product.trim()}</strong>: 
                        <span class="text-green-400">+${((b['Dollar Sales % Change vs YA'] || 0) * 100).toFixed(1)}%</span> growth
                        ($${formatNumber(b['Dollar Sales'])} sales)</li>
                    `).join('')}
                </ol>
            `;

            displayTable(top10, ['Product', 'Dollar Sales', 'Dollar Sales % Change vs YA', 'Unit Sales % Change vs YA']);

            createChart(
                top10.map(b => b.Product.trim()),
                top10.map(b => (b['Dollar Sales % Change vs YA'] || 0) * 100),
                'Top 10 Growth Leaders (% Change vs YA)',
                'bar',
                true
            );
        }

        function showWorstPerforming(data) {
            const brands = data.filter(row => {
                const product = row.Product || '';
                const spaces = product.match(/^\s*/)[0].length;
                return spaces === 6 && row['Dollar Sales'] > 10000 && row['Dollar Sales % Change vs YA'] !== null;
            });

            brands.sort((a, b) => (a['Dollar Sales % Change vs YA'] || 999) - (b['Dollar Sales % Change vs YA'] || 999));
            const bottom10 = brands.slice(0, 10);

            document.getElementById('answerText').innerHTML = `
                <p class="text-lg mb-4">Brands facing the biggest declines:</p>
                <ol class="list-decimal list-inside space-y-1 ml-4">
                    ${bottom10.map(b => `
                        <li><strong>${b.Product.trim()}</strong>: 
                        <span class="text-red-400">${((b['Dollar Sales % Change vs YA'] || 0) * 100).toFixed(1)}%</span> change
                        ($${formatNumber(b['Dollar Sales'])} current sales)</li>
                    `).join('')}
                </ol>
            `;

            displayTable(bottom10, ['Product', 'Dollar Sales', 'Dollar Sales % Change vs YA', 'ACV Weighted Distribution']);

            createChart(
                bottom10.map(b => b.Product.trim()),
                bottom10.map(b => (b['Dollar Sales % Change vs YA'] || 0) * 100),
                'Brands with Largest Declines (% Change vs YA)',
                'bar',
                true
            );
        }

        function showMarketShare(data) {
            const brands = data.filter(row => {
                const product = row.Product || '';
                const spaces = product.match(/^\s*/)[0].length;
                return spaces === 6 && row['Dollar Sales'] > 0;
            });

            const totalSales = brands.reduce((sum, b) => sum + (b['Dollar Sales'] || 0), 0);
            brands.forEach(b => {
                b.marketShare = ((b['Dollar Sales'] || 0) / totalSales) * 100;
            });

            brands.sort((a, b) => b.marketShare - a.marketShare);
            const top10 = brands.slice(0, 10);

            document.getElementById('answerText').innerHTML = `
                <p class="text-lg mb-4">Market share distribution across top brands:</p>
                <div class="space-y-2">
                    ${top10.map(b => `
                        <div class="flex items-center gap-3">
                            <div class="w-48 truncate font-medium">${b.Product.trim()}</div>
                            <div class="flex-1 bg-slate-700 rounded-full h-6 relative overflow-hidden">
                                <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-full rounded-full transition-all" 
                                     style="width: ${b.marketShare}%"></div>
                                <span class="absolute inset-0 flex items-center justify-center text-xs font-bold">
                                    ${b.marketShare.toFixed(1)}%
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            displayTable(top10.map(b => ({
                Product: b.Product,
                'Dollar Sales': b['Dollar Sales'],
                'Market Share %': b.marketShare.toFixed(2),
                'YA Change %': ((b['Dollar Sales % Change vs YA'] || 0) * 100).toFixed(1)
            })), ['Product', 'Dollar Sales', 'Market Share %', 'YA Change %']);

            createChart(
                top10.map(b => b.Product.trim()),
                top10.map(b => b.marketShare),
                'Market Share - Top 10 Brands',
                'pie'
            );
        }

        function showPriceAnalysis(data) {
            const brands = data.filter(row => {
                const product = row.Product || '';
                const spaces = product.match(/^\s*/)[0].length;
                return spaces === 6 && row['Dollar Sales'] > 50000 && row['Price per Unit'] > 0;
            });

            brands.sort((a, b) => (b['Price per Unit'] || 0) - (a['Price per Unit'] || 0));
            const top10 = brands.slice(0, 10);

            const avgPrice = brands.reduce((sum, b) => sum + (b['Price per Unit'] || 0), 0) / brands.length;

            document.getElementById('answerText').innerHTML = `
                <p class="text-lg mb-4">Price positioning analysis:</p>
                <p class="mb-4">Average category price per unit: <strong class="text-cyan-400">$${avgPrice.toFixed(2)}</strong></p>
                <p class="mb-2">Highest-priced brands:</p>
                <ol class="list-decimal list-inside space-y-1 ml-4">
                    ${top10.map(b => `
                        <li><strong>${b.Product.trim()}</strong>: $${(b['Price per Unit'] || 0).toFixed(2)}/unit
                        (${((b['Price per Unit Change vs YA'] || 0) * 100).toFixed(1)}% change vs YA)</li>
                    `).join('')}
                </ol>
            `;

            displayTable(top10, ['Product', 'Price per Unit', 'Price per Unit Change vs YA', 'Dollar Sales']);

            createChart(
                top10.map(b => b.Product.trim()),
                top10.map(b => b['Price per Unit']),
                'Price per Unit Comparison',
                'bar'
            );
        }

        function displayTable(data, columns) {
            if (!data || data.length === 0) {
                document.getElementById('tableContainer').classList.add('hidden');
                return;
            }

            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');

            thead.innerHTML = `
                <tr class="border-b border-purple-500/30">
                    ${columns.map(col => `<th class="px-4 py-3 text-left text-purple-300 font-semibold">${col}</th>`).join('')}
                </tr>
            `;

            tbody.innerHTML = data.map((row, i) => `
                <tr class="border-b border-slate-700 hover:bg-slate-700/30 transition-colors">
                    ${columns.map(col => {
                        let value = row[col];
                        if (typeof value === 'number') {
                            if (col.includes('%')) {
                                const pct = (value * 100).toFixed(1);
                                const color = value > 0 ? 'text-green-400' : value < 0 ? 'text-red-400' : '';
                                return `<td class="px-4 py-3 ${color}">${pct}%</td>`;
                            } else if (col.includes('Sales') || col.includes('Dollar')) {
                                return `<td class="px-4 py-3">$${formatNumber(value)}</td>`;
                            }
                            return `<td class="px-4 py-3">${value.toFixed(2)}</td>`;
                        }
                        return `<td class="px-4 py-3 ${i === 0 ? 'font-medium' : ''}">${value || 'N/A'}</td>`;
                    }).join('')}
                </tr>
            `).join('');

            document.getElementById('tableContainer').classList.remove('hidden');
        }

        function createChart(labels, data, title, type = 'bar', isPercentage = false) {
            if (currentChart) {
                currentChart.destroy();
            }

            const canvas = document.getElementById('dataChart');
            const ctx = canvas.getContext('2d');

            const colors = type === 'pie' 
                ? labels.map((_, i) => `hsl(${(i * 360 / labels.length)}, 70%, 60%)`)
                : data.map(val => val >= 0 ? 'rgba(139, 92, 246, 0.8)' : 'rgba(236, 72, 153, 0.8)');

            currentChart = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: title,
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('0.8', '1')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: type === 'pie',
                            labels: { color: '#e2e8f0' }
                        },
                        title: {
                            display: true,
                            text: title,
                            color: '#e2e8f0',
                            font: { size: 16 }
                        }
                    },
                    scales: type !== 'pie' ? {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                color: '#cbd5e1',
                                callback: function(value) {
                                    return isPercentage ? value + '%' : value;
                                }
                            },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { 
                                color: '#cbd5e1',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    } : {}
                }
            });

            document.getElementById('chartContainer').classList.remove('hidden');
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toFixed(0);
        }

        document.getElementById('queryInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                processQuery();
            }
        });
    </script>
</body>
</html>
